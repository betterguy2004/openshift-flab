// Jenkins Pipeline for Spring Petclinic on OpenShift
// Uses Jib Maven Plugin for containerization without Docker
pipeline {
  agent {
    kubernetes {
      namespace 'jenkins-agents-hungpq52'
      yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-agent
  imagePullSecrets:
    - name: redhat-pull-secret
  containers:
  - name: jnlp
    image: registry.redhat.io/ocp-tools-4/jenkins-agent-base-rhel8:latest
    env:
    - name: HOME
      value: /home/jenkins
    volumeMounts:
    - name: workspace
      mountPath: /home/jenkins/agent
    - name: home
      mountPath: /home/jenkins
  - name: maven
    image: maven:3.9-eclipse-temurin-17
    command: ["cat"]
    tty: true
    env:
    - name: HOME
      value: /home/jenkins
    - name: MAVEN_OPTS
      value: "-Dmaven.repo.local=/home/jenkins/.m2/repository"
    - name: NEXUS_USERNAME
      value: "admin"
    - name: NEXUS_PASSWORD
      value: "123456789"
    volumeMounts:
    - name: workspace
      mountPath: /home/jenkins/agent
    - name: home
      mountPath: /home/jenkins
  volumes:
  - name: workspace
    persistentVolumeClaim:
      claimName: jenkins-agent-workspace
  - name: home
    emptyDir: {}
      '''
    }
  }
  
  environment {
    APP_NS = 'petclinic-hungpq52'
    NEXUS_REGISTRY = 'nexus.apps.s68'
    IMAGE_NAME = 'petclinic'
    IMAGE_TAG = "${BUILD_NUMBER}"
    NEXUS_USERNAME = 'admin'
    NEXUS_PASSWORD = '123456789'
  }
  
  stages {
    stage('Checkout') {
      steps {
        echo '=== Checking out Spring Petclinic from GitHub ==='
        git url: 'https://github.com/spring-projects/spring-petclinic', branch: 'main'
      }
    }
    
    stage('Maven Build & Push Image') {
      steps {
        container('maven') {
          echo '=== Building application and pushing image with Jib ==='
          sh '''
            mvn -version
            
            # Build application and create container image with Jib
            # Jib builds and pushes in one step, no Docker daemon needed
            mvn -B -DskipTests clean package jib:build
            
            echo "✅ Image built and pushed to ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest"
          '''
        }
      }
    }
    
    stage('Deploy to OpenShift') {
      steps {
        container('jnlp') {
          echo '=== Deploying to OpenShift ==='
          sh """
            oc version
            oc project ${APP_NS}
            
            # Check if deployment exists
            if oc get deployment petclinic -n ${APP_NS} 2>/dev/null; then
              echo "Deployment exists, triggering rollout..."
              oc rollout restart deployment/petclinic -n ${APP_NS}
            else
              echo "Creating new deployment..."
              oc new-app ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest \
                --name=petclinic \
                -n ${APP_NS}
              
              # Expose service
              oc expose svc/petclinic -n ${APP_NS} || echo "Route already exists"
            fi
            
            # Wait for rollout to complete
            oc rollout status deployment/petclinic -n ${APP_NS} --timeout=5m
          """
        }
      }
    }
    
    stage('Verify Deployment') {
      steps {
        container('jnlp') {
          echo '=== Verifying deployment ==='
          sh """
            # Get route URL
            ROUTE=\$(oc get route petclinic -n ${APP_NS} -o jsonpath='{.spec.host}')
            echo "Application URL: http://\${ROUTE}"
            
            # Wait for application to be ready
            echo "Waiting for application to start..."
            sleep 15
            
            # Test HTTP endpoint
            HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" http://\${ROUTE}/ || echo "000")
            echo "HTTP Response Code: \${HTTP_CODE}"
            
            if [ "\${HTTP_CODE}" = "200" ]; then
              echo "✅ Application is accessible and healthy"
            else
              echo "⚠️  Application returned HTTP \${HTTP_CODE}"
              echo "Check pod logs for details:"
              oc logs -l app=petclinic -n ${APP_NS} --tail=50
            fi
          """
        }
      }
    }
  }
  
  post {
    always {
      echo '=== Pipeline execution completed ==='
    }
    success {
      echo '✅ Pipeline succeeded! Petclinic deployed successfully with Jib.'
    }
    failure {
      echo '❌ Pipeline failed! Check logs for details.'
    }
  }
}
